# Image de base
FROM debian:10.2

# Variables
ENV debuser="toto"
# Attention mettre au moins 8 caractères
ENV debpasswd="toto2019"
ENV rootpasswd="$debpasswd"

RUN yes $rootpasswd | passwd

#Configuration des locales
RUN apt-get update && apt-get install locales -y && rm -rf /var/lib/apt/lists/* \
    && localedef -i fr_FR -c -f UTF-8 -A /usr/share/locale/locale.alias fr_FR.UTF-8
ENV LANG fr_FR.utf8

#détails sur notre organisation
ENV domain="debian.lan"
ENV commonname="$domain"
ENV country="FR"
ENV state="Paris"
ENV locality="0"
ENV organization="$domain"
ENV organizationalunit="IT"
ENV email="$debuser@$domain"

WORKDIR /home/$debuser/

# création d'un utilisateur
RUN useradd -ms /bin/bash $debuser && yes $debpasswd | passwd $debuser

# Installation et configuration de Mate
RUN apt install mate-desktop-environment-core -y

# Installation et configuration de tigervnc
RUN apt install tigervnc-standalone-server -y && sleep 5
RUN su - $debuser -c "yes $debpasswd | vncpasswd"
RUN su - $debuser -c "echo 'exec /usr/bin/mate-session &' > /home/$debuser/.vnc/xstartup"
CMD su - $debuser -c "vncserver :1 -geometry 800x600 -localhost no" && echo "Démarrage du service" && sleep 30 && su - $debuser -c "websockify -D --web=/usr/share/novnc/ --cert=/home/$debuser/novnc.pem 6080 localhost:5901"

# Installation et configuration de novnc
RUN apt install openssl -y
RUN apt install novnc python-websockify -y

#ssl
RUN su - $debuser -c "$(openssl req -x509 -nodes -newkey rsa:2048 -keyout novnc.pem -out novnc.pem -days 365 -subj "/C=$country/ST=$state/L=$locality/O=$organization/OU=$organizationalunit/CN=$commonname/emailAddress=$email")"

EXPOSE 6080
EXPOSE 5901

VOLUME /home/$debuser/Partage
